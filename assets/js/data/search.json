[ { "title": "How to test an API expecting Firebase token", "url": "/posts/how-to-test-an-api-expecting-firebase-token/", "categories": "Tech, Tutorial", "tags": "firebase, postman, backend", "date": "2022-05-07 19:50:00 -0700", "snippet": "Let’s say you are developing a backend API and you are protecting it with firebase tokens. This saves lots of development time on the frontend (mobile or web) just because Firebase Auth SDK does all the heavy lifting for token generation, refresh, etc, as well as on the backend for the exact same reason. But when you want to test this API with Postman or any other REST client you may face a problem, how to get the same token as the client receives from the Firebase SDK?One of the ways to do it is to launch a client app and grab a token from there. Personally, I wasted lots of time doing this.Better SolutionThere is a way better option for doing it, and I was surprised by how easy it is. All we need to do is to use Firebase Auth REST API (https://firebase.google.com/docs/reference/rest/auth). It provides simple API calls we can use to manage our Firebase users as well as tokens.ExampleLet’s see by example how we can do it, I created a sample firebase project and deployed a simple cloud function:const functions = require(&quot;firebase-functions&quot;);const serviceAccount = require(&quot;./service-account.json&quot;);const { initializeApp, cert } = require(&#39;firebase-admin/app&#39;);const { getAuth } = require(&#39;firebase-admin/auth&#39;);const app = initializeApp({ credential: cert(serviceAccount)})const auth = getAuth(app)exports.protectedEndpoint = functions.https.onRequest(async (request, response) =&amp;gt; { try { const xApiToken = request.headers[&#39;x-api-token&#39;] const decodedToken = await auth.verifyIdToken(xApiToken) response.send({ decodedToken }); } catch (ex) { response.status(403).json({ error: &quot;&#39;x-api-token&#39; header is required!&quot; }) }});Let’s try to call it via cURL:➜ ~ curl https://us-central1-givemefirebasetoken-sample.cloudfunctions.net/protectedEndpoint{&quot;error&quot;:&quot;&#39;x-api-token&#39; header is required!&quot;}%As expected we got our error, because auth.verifyIdToken() failed.Now let’s try to get the token via Rest API. The first thing we will need is an API_KEY for our Firebase project. The easiest way to get it is to create a Web app in your firebase console. Next, you’ll see your API_KEY in it. Here is an example from my sample project:After we have our apiKey we can start making calls to the firebase, link to the detailed API reference: https://firebase.google.com/docs/reference/rest/authPersonally I use 3 methods: Sign up with email / password (https://firebase.google.com/docs/reference/rest/auth#section-create-email-password) Sign in with email / password (https://firebase.google.com/docs/reference/rest/auth#section-sign-in-email-password) Delete account (https://firebase.google.com/docs/reference/rest/auth#section-delete-account)Delete is useful if we want to create a new user each time, we can use it in our autotests. So our flow would be like this: Sign Up with email/password. Run API tests. Delete user.Ok, let’s create a new user with API request:curl --location --request POST &#39;https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=AIzaSyAHV1eUu8EqCSUeycofXqfL******&#39; \\--header &#39;Content-Type: application/json&#39; \\--data-raw &#39;{ &quot;email&quot;: &quot;anton.krasov@gmail.com&quot;, &quot;password&quot;: &quot;******&quot;, &quot;returnSecureToken&quot;: true}&#39;Our response should look like this:{ &quot;kind&quot;: &quot;identitytoolkit#SignupNewUserResponse&quot;, &quot;idToken&quot;: &quot;eyJhbGciOiJSUzI1NiIsImtpZ....gkULJig1ypXaA&quot;, &quot;email&quot;: &quot;anton.krasov@gmail.com&quot;, &quot;refreshToken&quot;: &quot;AIwUaOkfNuMg8Kdatx-Hy8_5Ti0sm....-dKiN0CGkDfX1ch5f69g5Y5K&quot;, &quot;expiresIn&quot;: &quot;3600&quot;, &quot;localId&quot;: &quot;aoiC7bM0v....ueGMRegf1k2&quot;}idToken is exactly the same token we will receive from our Firebase Auth SDK.localId is our new user Id.Just remember that you need to have Email/Password auth provider enabled in your Authentication settings:Now, we have an idToken let’s try to execute our sample call again:curl --location --request GET &#39;https://us-central1-givemefirebasetoken-sample.cloudfunctions.net/protectedEndpoint&#39; \\--header &#39;x-api-token: eyJhbGciOiJSUzI1NiIsImtpZ....09HlrF49MRWo9qq0_c6UiMHdBZUavNXyuFyjC85dpSxJrNtJSwH5OQa22dIwdbNmfMqz6ljAivIkjw5aX2GrF5ViFCdp4Tew5iw&#39;and we got our decodedToken in response:{&quot;decodedToken&quot;:{&quot;iss&quot;:&quot;https://securetoken.google.com/givemefirebasetoken-sample&quot;,&quot;aud&quot;:&quot;givemefirebasetoken-sample&quot;,&quot;auth_time&quot;:1651977397,&quot;user_id&quot;:&quot;aoiC7bM0vFQTMPj24ueGMRegf1k2&quot;,&quot;sub&quot;:&quot;aoiC7bM0vFQTMPj24ueGMRegf1k2&quot;,&quot;iat&quot;:1651977397,&quot;exp&quot;:1651980997,&quot;email&quot;:&quot;anton.krasov@gmail.com&quot;,&quot;email_verified&quot;:false,&quot;firebase&quot;:{&quot;identities&quot;:{&quot;email&quot;:[&quot;anton.krasov@gmail.com&quot;]},&quot;sign_in_provider&quot;:&quot;password&quot;},&quot;uid&quot;:&quot;aoiC7bM0vFQTMPj24ueGMRegf1k2&quot;}}Leverage Postman EnvironmentsNow we know the API calls we need to execute to get the user’s info, let’s leverage postman variables and environments (https://learning.postman.com/docs/sending-requests/variables/) to store the token and use it with our own backend API calls.First thing, let’s create env and setup variables we need:Variables are pretty self explanatory ;)Now, let’s create our accounts:signUp request, and execute it:Now, once we receive our token, let’s save it in our environment using Tests tab (https://learning.postman.com/docs/writing-scripts/test-scripts/):var jsonData = JSON.parse(responseBody);pm.expect(jsonData.idToken).to.be.a(&#39;string&#39;);postman.setEnvironmentVariable(&quot;firebaseIdToken&quot;, jsonData.idToken);On the second line, we also validate that we have idToken and it’s a string. This is required to prevent setting up the wrong firebaseIdToken env var if our request failed. Let’s say you called accounts:signUp request twice and got an error from the firebase saying that the user already exists.Now, after the execution we’ll have our token in our env, and we can use it in our own API calls.Automatic token retrievalPostman has a nice feature called pre-request scripts: https://learning.postman.com/docs/writing-scripts/pre-request-scripts/We can use it to automate retrieving of our token and setting of our env, and the best thing about it is that we can create a pre-request script for the whole collection! This means that we won’t need to call any of the firebase requests manually.Here is an example script:const firebaseApiKey = pm.environment.get(&quot;firebaseApiKey&quot;)const firebaseTestUserEmail = pm.environment.get(&quot;firebaseTestUserEmail&quot;)const firebaseTestUserPassword = pm.environment.get(&quot;firebaseTestUserPassword&quot;)const options = { url: `https://identitytoolkit.googleapis.com/v1/accounts:signInWithPassword?key=${firebaseApiKey}`, method: &#39;POST&#39;, header: { &#39;Accept&#39;: &#39;*/*&#39;, &#39;Content-Type&#39;: &#39;application/json&#39;, }, body: { mode: &#39;raw&#39;, raw: JSON.stringify({ &quot;email&quot;: firebaseTestUserEmail, &quot;password&quot;: firebaseTestUserPassword, &quot;returnSecureToken&quot;: true }) }};pm.sendRequest(options, function (err, res) { const respData = res.json(); pm.environment.set(&quot;firebaseIdToken&quot;, respData.idToken); pm.environment.set(&quot;firebaseUID&quot;, respData.localId);});Thank you, feel free to contact me via email: anton.krasov@gmail.com if you have any questions ;)" } ]
